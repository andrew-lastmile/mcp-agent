name: Canary Workflow

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  canary:
    environment: canary
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      MCPAC_API_KEY: ${{ secrets.MCPAC_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install uv
          uv pip install -e . --system
          # Individually add required packages
          uv pip install fastmcp --system
          uv pip install httpx --system
          uv pip install pydantic --system
          uv pip install rich --system
          uv version

      - name: Deploy
        id: deploy
        run: |
          python canary/deploy_app.py | tee full_deploy.log | tail -n 1 > deploy_output.json
        continue-on-error: false

      - name: Test app
        id: test
        run: |
          APP_URL=$(jq -r '.app_url' deploy_output.json)
          python canary/test_app.py "$APP_URL" | tee full_test.log | tail -n 1 > test_output.json || exit 1

      - name: Normalize status
        if: always()
        run: |
          if jq -e .success test_output.json >/dev/null 2>&1; then
            SUCCESS=$(jq -r '.success' test_output.json)
            if [ "$SUCCESS" = "true" ]; then
              STATUS="success"
            else
              STATUS="failure"
            fi
          else
            STATUS="error"
          fi
          echo "STATUS=$STATUS" >> $GITHUB_ENV

      - name: Log results
        id: log
        run: |
          APP_ID=$(jq -r '.app_id // empty' deploy_output.json)
          DEPLOY_LATENCY=$(jq -r '.latency_s // 0' deploy_output.json)
          TEST_LATENCY=$(jq -r '.latency_s // 0' test_output.json)
          TOTAL_LATENCY=$(echo "$DEPLOY_LATENCY + $TEST_LATENCY" | bc)
          DEPLOY_STDOUT=$(jq -r '.output // ""' deploy_output.json | tail -c 500)
          TEST_STDOUT=$(jq -r '.stdout // ""' test_output.json | tail -c 500)
          DEPLOY_SUCCESS=$(jq -r '.success // false' deploy_output.json)
          TEST_SUCCESS=$(jq -r '.success // false' test_output.json)
          STATUS=$(jq -r '.success // "unknown"' test_output.json)
      
          echo "ğŸ“Š Logging results for app_id=$APP_ID (status=$STATUS)"
          echo "  Deploy latency: ${DEPLOY_LATENCY}s"
          echo "  Test latency:   ${TEST_LATENCY}s"
          echo "  Total latency:  ${TOTAL_LATENCY}s"
      
          python canary/log_result.py \
            "$STATUS" \
            "$APP_ID" \
            "$TOTAL_LATENCY" \
            "$DEPLOY_LATENCY" \
            "$TEST_LATENCY" \
            "$DEPLOY_STDOUT" \
            "" \
            "$TEST_STDOUT" \
            ""
      
          # âœ… Escape logs safely for Slack JSON
          DEPLOY_STDOUT_ESCAPED=$(echo "$DEPLOY_STDOUT" | jq -Rs .)
          TEST_STDOUT_ESCAPED=$(echo "$TEST_STDOUT" | jq -Rs .)
      
          {
            echo "STATUS=$STATUS"
            echo "APP_ID=$APP_ID"
            echo "DEPLOY_LATENCY=$DEPLOY_LATENCY"
            echo "TEST_LATENCY=$TEST_LATENCY"
            echo "TOTAL_LATENCY=$TOTAL_LATENCY"
            echo "DEPLOY_SUCCESS=$DEPLOY_SUCCESS"
            echo "TEST_SUCCESS=$TEST_SUCCESS"
            echo "DEPLOY_STDOUT_ESCAPED=$DEPLOY_STDOUT_ESCAPED"
            echo "TEST_STDOUT_ESCAPED=$TEST_STDOUT_ESCAPED"
          } >> $GITHUB_ENV
          
      - name: Cleanup
        if: always()
        run: |
          APP_ID=$(jq -r '.app_id // empty' deploy_output.json)
          if [ -n "$APP_ID" ]; then
            python canary/delete_app.py "$APP_ID" | tee full_delete.log | tail -n 1 > delete_output.json
          fi
            
      - name: Notify Slack
        if: always()
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ env.STATUS == 'success' && '#36a64f' || env.STATUS == 'failure' && '#9ca3af' || '#e01e5a' }}",
                  "blocks": [
                    /* â”€â”€ Top meta (small font) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "*App ID:* `${{ env.APP_ID }}`" }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "*Status:* `${{ env.STATUS }}`" },
                        { "type": "mrkdwn", "text": "*Total:* `${{ env.TOTAL_LATENCY }}s`" },
                        { "type": "mrkdwn", "text": "*Deploy:* `${{ env.DEPLOY_LATENCY }}s`" },
                        { "type": "mrkdwn", "text": "*Test:* `${{ env.TEST_LATENCY }}s`" }
                      ]
                    },
      
                    /* â”€â”€ Deploy output â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "${{ env.DEPLOY_SUCCESS == 'true' && 'âœ… *Deploy Output*' || 'âŒ *Deploy Output*' }}" }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": ${{ env.DEPLOY_STDOUT_ESCAPED }} }
                      ]
                    },
      
                    /* Divider between sections */
                    { "type": "divider" },
      
                    /* â”€â”€ Tool Call output â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "${{ env.TEST_SUCCESS == 'true' && 'âœ… *Tool Call Output*' || 'âŒ *Tool Call Output*' }}" }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": ${{ env.TEST_STDOUT_ESCAPED }} }
                      ]
                    },
      
                    /* â”€â”€ Footer / provenance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "_Triggered by <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions Canary Job>_" }
                      ]
                    }
                  ]
                }
              ]
            }
