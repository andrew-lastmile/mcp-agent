- name: Notify Slack
  if: always()
  uses: slackapi/slack-github-action@v2.1.1
  with:
    webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
    webhook-type: incoming-webhook
    payload: |
      {
        "text": "Canary result: ${{ env.STATUS }}",  // fallback for clients without blocks
        "blocks": [
          {
            "type": "context",
            "elements": [
              { "type": "mrkdwn", "text": "*App ID:* `${{ env.APP_ID != '' && env.APP_ID || 'n/a' }}`" }
            ]
          },
          {
            "type": "context",
            "elements": [
              { "type": "mrkdwn", "text": "*Status:* `${{ env.STATUS }}`" },
              { "type": "mrkdwn", "text": "*Deploy App:* ${{ env.DEPLOY_SUCCESS == 'true' && '✅' || '❌' }}" },
              { "type": "mrkdwn", "text": "*Tool Calls:* ${{ env.TEST_SUCCESS == 'true' && '✅' || '❌' }}" }
            ]
          },
          {
            "type": "context",
            "elements": [
              { "type": "mrkdwn", "text": "*Total:* `${{ env.TOTAL_LATENCY }}s`" },
              { "type": "mrkdwn", "text": "*Deploy App:* `${{ env.DEPLOY_LATENCY }}s`" },
              { "type": "mrkdwn", "text": "*Tool Calls:* `${{ env.TEST_LATENCY }}s`" }
            ]
          },

          { "type": "divider" },

          { "type": "section", "text": { "type": "mrkdwn", "text": "${{ env.DEPLOY_SUCCESS == 'true' && '✅ *Deploy Output*' || '❌ *Deploy Output*' }}" } },
          { "type": "section", "text": { "type": "mrkdwn", "text": ${{ env.DEPLOY_STDOUT_ESCAPED }} } },

          { "type": "divider" },

          { "type": "section", "text": { "type": "mrkdwn", "text": "${{ env.TEST_SUCCESS == 'true' && '✅ *Tool Call Output*' || '❌ *Tool Call Output*' }}" } },
          { "type": "section", "text": { "type": "mrkdwn", "text": ${{ env.TEST_STDOUT_ESCAPED }} } },

          {
            "type": "context",
            "elements": [
              { "type": "mrkdwn", "text": "_Triggered by <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions Canary Job>_" }
            ]
          }
        ]
      }
