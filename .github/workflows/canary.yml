name: Canary Workflow

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  canary:
    environment: canary
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      MCPAC_API_KEY: ${{ secrets.MCPAC_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install uv
          uv pip install -e . --system
          uv pip install fastmcp --system
          uv pip install httpx --system
          uv pip install pydantic --system
          uv pip install rich --system
          uv version

      - name: Deploy
        id: deploy
        run: |
          set -eo pipefail
          python canary/deploy_app.py | tee full_deploy.log | tail -n 1 > deploy_output.json
        continue-on-error: false

      - name: Test app
        id: test
        run: |
          set -eo pipefail
          APP_URL=$(jq -r '.app_url' deploy_output.json 2>/dev/null || echo "")
          python canary/test_app.py "$APP_URL" | tee full_test.log | tail -n 1 > test_output.json || exit 1

      - name: Normalize status
        id: normalize
        if: always()
        env:
          DEPLOY_OUTCOME: ${{ steps.deploy.outcome }}
          TEST_OUTCOME: ${{ steps.test.outcome }}
        run: |
          set -e
          if [ "$DEPLOY_OUTCOME" != "success" ]; then
            STATUS="canary-down"                       # deploy failed ‚Üí infra issue
          elif [ "$TEST_OUTCOME" = "success" ]; then
            # We have a test result; honor it if present, else assume failure
            if jq -e .success test_output.json >/dev/null 2>&1; then
              if [ "$(jq -r '.success' test_output.json)" = "true" ]; then
                STATUS="success"
              else
                STATUS="failure"
              fi
            else
              STATUS="failure"                         # test ran but no JSON ‚Üí still a test failure
            fi
          elif [ "$TEST_OUTCOME" = "failure" ]; then
            STATUS="failure"                           # tool call / assertion / timeout
          else
            STATUS="canary-down"                       # skipped or unknown
          fi
          echo "STATUS=$STATUS" >> "$GITHUB_ENV"
          echo "::notice title=Normalized status::$STATUS"

      - name: Log results
        id: log
        if: always()
        run: |
          set -e
          # Guard all jq reads to avoid failing when files are missing
          APP_ID=$( [ -f deploy_output.json ] && jq -r '.app_id // empty' deploy_output.json || echo "" )
          DEPLOY_LATENCY=$( [ -f deploy_output.json ] && jq -r '.latency_s // 0' deploy_output.json || echo 0 )
          TEST_LATENCY=$( [ -f test_output.json ] && jq -r '.latency_s // 0' test_output.json || echo 0 )
          TOTAL_LATENCY=$(echo "$DEPLOY_LATENCY + $TEST_LATENCY" | bc)

          DEPLOY_STDOUT=$( [ -f deploy_output.json ] && jq -r '.output // ""' deploy_output.json | tail -c 150 || echo "" )
          TEST_STDOUT=$( [ -f test_output.json ] && jq -r '.stdout // ""' test_output.json | tail -c 150 || echo "" )

          DEPLOY_SUCCESS=$( [ -f deploy_output.json ] && jq -r '.success // false' deploy_output.json || echo false )
          TEST_SUCCESS=$( [ -f test_output.json ] && jq -r '.success // false' test_output.json || echo false )

          STATUS="${{ env.STATUS }}"  # ‚Üê use the normalized status

          echo "üìä Logging results for app_id=$APP_ID (status=$STATUS)"
          echo "  Deploy latency: ${DEPLOY_LATENCY}s"
          echo "  Test latency:   ${TEST_LATENCY}s"
          echo "  Total latency:  ${TOTAL_LATENCY}s"

          python canary/log_result.py \
            "$STATUS" \
            "$APP_ID" \
            "$TOTAL_LATENCY" \
            "$DEPLOY_LATENCY" \
            "$TEST_LATENCY" \
            "$DEPLOY_STDOUT" \
            "" \
            "$TEST_STDOUT" \
            ""

          # Escape logs safely for Slack JSON
          DEPLOY_STDOUT_ESCAPED=$(echo "$DEPLOY_STDOUT" | jq -Rs .)
          TEST_STDOUT_ESCAPED=$(echo "$TEST_STDOUT" | jq -Rs .)

          {
            echo "STATUS=$STATUS"
            echo "APP_ID=$APP_ID"
            echo "DEPLOY_LATENCY=$DEPLOY_LATENCY"
            echo "TEST_LATENCY=$TEST_LATENCY"
            echo "TOTAL_LATENCY=$TOTAL_LATENCY"
            echo "DEPLOY_SUCCESS=$DEPLOY_SUCCESS"
            echo "TEST_SUCCESS=$TEST_SUCCESS"
            echo "DEPLOY_STDOUT_ESCAPED=$DEPLOY_STDOUT_ESCAPED"
            echo "TEST_STDOUT_ESCAPED=$TEST_STDOUT_ESCAPED"
          } >> "$GITHUB_ENV"

      - name: Cleanup
        if: always()
        run: |
          APP_ID=$(jq -r '.app_id // empty' deploy_output.json 2>/dev/null || echo "")
          if [ -n "$APP_ID" ]; then
            python canary/delete_app.py "$APP_ID" | tee full_delete.log | tail -n 1 > delete_output.json || true
          fi

      - name: Notify Slack
        if: always()
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ env.STATUS == 'success' && '#36a64f' || env.STATUS == 'failure' && '#e01e5a' || '#f2c744' }}",
                  "blocks": [
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "*App ID:* `${{ env.APP_ID }}`" }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "*Status:* `${{ env.STATUS }}`" },
                        { "type": "mrkdwn", "text": "*Total:* `${{ env.TOTAL_LATENCY }}s`" },
                        { "type": "mrkdwn", "text": "*Deploy:* `${{ env.DEPLOY_LATENCY }}s`" },
                        { "type": "mrkdwn", "text": "*Test:* `${{ env.TEST_LATENCY }}s`" }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "${{ env.DEPLOY_SUCCESS == 'true' && '‚úÖ *Deploy Output*' || '‚ùå *Deploy Output*' }}" }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": ${{ env.DEPLOY_STDOUT_ESCAPED }} }
                      ]
                    },
                    { "type": "divider" },
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "${{ env.TEST_SUCCESS == 'true' && '‚úÖ *Tool Call Output*' || '‚ùå *Tool Call Output*' }}" }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": ${{ env.TEST_STDOUT_ESCAPED }} }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "_Triggered by <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions Canary Job>_" }
                      ]
                    }
                  ]
                }
              ]
            }
