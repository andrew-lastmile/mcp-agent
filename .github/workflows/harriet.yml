name: Harriet Canary

on:
  schedule:
    - cron: "0 * * * *"   # hourly (UTC)
  workflow_dispatch:       # allow manual runs too

permissions:
  contents: read

concurrency:
  group: hourly-mcp-test
  cancel-in-progress: true

# Make the MCP URL available to all steps
env:
  APP_URL: ${{ secrets.MCP_SERVER_URL_ALT }}

jobs:
  test-app:
    runs-on: ubuntu-latest
    environment: canary
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-asyncio fastmcp

      # --- Test the MCP app using your test_app.py script ---
      - name: Test app
        id: test  
        env:
          MCPAC_API_KEY: ${{ secrets.MCPAC_API_KEY }}
        run: |
          set -euo pipefail
          echo "Testing MCP app at: $APP_URL"
          
          # Run canary/test_app.py with APP_URL, stream logs to console,
          # capture full log, and write final JSON line to test_output.json
          python canary/test_app.py "$APP_URL" \
            | tee full_test.log \
            | tail -n 1 > test_output.json || exit 1

      # --- Normalize status based on test outcome + JSON success flag ---
      - name: Normalize status
        id: normalize
        if: always()
        env:
          TEST_OUTCOME: ${{ steps.test.outcome }}   # success | failure | cancelled | skipped
        run: |
          set -e

          case "$TEST_OUTCOME" in
            failure)
              STATUS="failure"
              ;;
            cancelled|skipped|"")
              # Tests never really ran ‚Üí canary-down
              STATUS="canary-down"
              ;;
            success)
              # Tests ran; trust JSON if present, else treat as failure
              if jq -e .success test_output.json >/dev/null 2>&1 && \
                 [ "$(jq -r '.success' test_output.json)" = "true" ]; then
                STATUS="success"
              else
                STATUS="failure"
              fi
              ;;
            *)
              STATUS="canary-down"
              ;;
          esac

          echo "STATUS=$STATUS" >> "$GITHUB_ENV"
          echo "::notice title=Normalized status::$STATUS"

      # --- Log results (no cleanup) ---
      - name: Log results
        id: log
        if: always()
        run: |
          set -e

          APP_URL_VALUE="${APP_URL:-unknown}"

          # Pull latency & success from test_output.json if present
          TEST_LATENCY=$(
            [ -f test_output.json ] && jq -r '.latency_s // 0' test_output.json || echo 0
          )
          TOTAL_LATENCY="$TEST_LATENCY"

          TEST_SUCCESS=$(
            [ -f test_output.json ] && jq -r '.success // false' test_output.json || echo false
          )

          # Trimmed tool output: use the JSON stdout field
          TEST_STDOUT=$(
            [ -f test_output.json ] && jq -r '.stdout // ""' test_output.json || echo ""
          )

          STATUS="${{ env.STATUS }}"

          echo "üìä Logging MCP test results (app_url=$APP_URL_VALUE status=$STATUS)"
          echo "  Test latency:  ${TEST_LATENCY}s"
          echo "  Total latency: ${TOTAL_LATENCY}s"

          # You can treat "deploy" fields as zero/empty since there's no deploy step
          DEPLOY_LATENCY=0
          DEPLOY_STDOUT=""

          python canary/log_result.py \
            "$STATUS" \
            "$APP_URL_VALUE" \
            "$TOTAL_LATENCY" \
            "$DEPLOY_LATENCY" \
            "$TEST_LATENCY" \
            "$DEPLOY_STDOUT" \
            "" \
            "$TEST_STDOUT" \
            ""

          # Escape logs safely for Slack JSON
          TEST_STDOUT_ESCAPED=$(echo "$TEST_STDOUT" | jq -Rs .)

          {
            echo "APP_URL=$APP_URL_VALUE"
            echo "TEST_LATENCY=$TEST_LATENCY"
            echo "TOTAL_LATENCY=$TOTAL_LATENCY"
            echo "TEST_SUCCESS=$TEST_SUCCESS"
            echo "TEST_STDOUT_ESCAPED=$TEST_STDOUT_ESCAPED"
          } >> "$GITHUB_ENV"

      # --- No cleanup step (nothing to tear down) ---

      # --- Rich Slack notification ---
      - name: Notify Slack (Hourly MCP smoke test)
        if: always()
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.DEV_SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "Hourly MCP smoke test",
              "attachments": [
                {
                  "color": "${{ env.STATUS == 'success' && '#36a64f' || env.STATUS == 'failure' && '#e01e5a' || '#f2c744' }}",
                  "blocks": [
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "*App URL:* `${{ env.APP_URL }}`" }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "*Status:* `${{ env.STATUS }}`" },
                        { "type": "mrkdwn", "text": "*Tool Calls:* ${{ env.TEST_SUCCESS == 'true' && '‚úÖ' || '‚ùå' }}" }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "*Total latency:* `${{ env.TOTAL_LATENCY }}s`" },
                        { "type": "mrkdwn", "text": "*Tool Calls latency:* `${{ env.TEST_LATENCY }}s`" }
                      ]
                    },

                    { "type": "divider" },

                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "${{ env.TEST_SUCCESS == 'true' && '‚úÖ *Tool Call Output*' || '‚ùå *Tool Call Output*' }}"
                        }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": ${{ env.TEST_STDOUT_ESCAPED }}
                        }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "_Triggered by <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Harriet Canary>_"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
